<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学籍管理系统</title>
    <!-- <link rel="stylesheet" href="./css/bootstrap.min.css">
    <script src="./jQuery/jquery-3.1.1.js"></script>
    <script src="./js/bootstrap.min.js"></script> -->
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-inverse" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">学籍管理系统</a>
            </div>
            <!-- 面包屑导航栏 -->
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">学生管理</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 按钮 -->
    <div class="container">
        <!-- ********************** -->
        <!-- **************** -->
        <!-- ************ -->
        <!-- ***** -->
        <!-- 更新学生信息 -->
        <a class="btn btn-primary" data-toggle="modal" href='#update' style="display: none;" id="update_a">编辑学生</a>
        <div class="modal fade" id="update">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">编辑学生</h4>
                    </div>
                    <div class="modal-body">
                        <!-- ------------------- -->
                        <!-- 更新学生信息的form表单 -->
                        <form class="form-horizontal" role="form" id="updateStu">
                            <div class="form-group">
                                <label for="" class="col-sm-2 control-label">姓名</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" name="name" id="update_name"
                                        placeholder="请输入姓名" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="" class="col-sm-2 control-label">年龄</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" name="age" id="update_age"
                                        placeholder="请输入年龄" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <!-- 性别： -->
                                <label for="checkbox" class="col-sm-2 control-label">性别</label>
                                <div class="col-sm-10">
                                    <label class="radio-inline">
                                        <input type="radio" name="sex" id="update_isMale" value="男"> 男
                                    </label>
                                    <label class="radio-inline">
                                        <input type="radio" name="sex" id="update_isFemale" value="女"> 女
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="" class="col-sm-2 control-label">手机</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" name="tel" id="update_tel"
                                        placeholder="请输入手机号码" required>
                                </div>
                            </div>
                            <input type="text" name="_id" id="update_id" style="display: none;">
                        </form>
                        <!-- ------------------- -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" id="updateBtn">更新</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ********************** -->
        <!-- **************** -->
        <!-- ************ -->
        <!-- ***** -->

        <!-- 添加新同学按钮 -->
        <a class="btn btn-primary" data-toggle="modal" href='#modal-id1'>添加新学生</a>
        <div class="modal fade" id="modal-id1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">添加新学生</h4>
                    </div>
                    <div class="modal-body">
                        <!-- ------------------- -->
                        <!-- 添加添加学生的form表单 -->
                        <form class="form-horizontal" role="form" id="addStu">
                            <div class="form-group">
                                <label for="" class="col-sm-2 control-label">姓名</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" name="name" placeholder="请输入姓名" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="" class="col-sm-2 control-label">年龄</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" name="age" placeholder="请输入年龄" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <!-- 性别： -->
                                <label for="checkbox" class="col-sm-2 control-label">性别</label>
                                <div class="col-sm-10">
                                    <label class="radio-inline">
                                        <input type="radio" name="sex" value="男"> 男
                                    </label>
                                    <label class="radio-inline">
                                        <input type="radio" name="sex" value="女"> 女
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="" class="col-sm-2 control-label">手机</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" name="tel" placeholder="请输入手机号码" required>
                                </div>
                            </div>
                        </form>
                        <!-- ------------------- -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" id="addBtn">添加</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 查询按钮 -->
        <a class="btn btn-success" data-toggle="modal" href='#modal-id'>查询</a>
        <div class="modal fade" id="modal-id">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">请输入搜索条件</h4>
                    </div>
                    <div class="modal-body">
                        <!-- 查询表单暂时未写 -->
                        <form class="form-horizontal" role="form" id="searchStu">
                            <div class="form-group">
                                <label for="name" class="col-sm-2 control-label">姓名</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="name" name="name" placeholder="请输入姓名"
                                        required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="age" class="col-sm-2 control-label">年龄</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="age" name="age" placeholder="请输入年龄"
                                        required>
                                </div>
                            </div>
                            <div class="form-group">
                                <!-- 性别： -->
                                <label for="checkbox" class="col-sm-2 control-label">性别</label>
                                <div class="col-sm-10" id="checkbox">
                                    <label class="radio-inline">
                                        <input type="radio" name="sex" id="isMale" value="男"> 男
                                    </label>
                                    <label class="radio-inline">
                                        <input type="radio" name="sex" id="isFemale" value="女"> 女
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="inputPassword" class="col-sm-2 control-label">手机</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="tel" name="tel"
                                        placeholder="请输入手机号码" required>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal" id="close_modal">关闭</button>
                        <button type="button" class="btn btn-primary" id="searchBtn">查询</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 条件查询显示 -->
        <p></p>
        <div id="condition_box">

        </div>



        <!-- 学生学籍信息 -->
        <div class="panel panel-default">
            <!-- Default panel contents -->
            <div class="panel-heading text-center">学生学籍信息</div>
            <!-- Table -->
            <table class="table">
                <thead>
                    <tr>
                        <th>姓名</th>
                        <th>年龄</th>
                        <th>性别</th>
                        <th>手机号</th>
                        <th>删除</th>
                        <th>编辑</th>
                    </tr>
                </thead>
                <tbody id="tbody-content">
                    <tr>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- 分页 -->
        <ul class="pagination">

        </ul>
    </div>
</body>
<script src="./js/ejs.js"></script>
<script type="text/html" id="index_table">
    <!-- 这里是返回的ejs模版 -->
    <%for(let i=0;i<data.length;i++){%>
<tr>
    <td><%=data[i].name%></td>
    <td><%=data[i].age%></td>
    <td><%=data[i].sex%></td>
    <td><%=data[i].tel%></td>
    <td>
        <input class='deleteInput' type="text" value='<%=data[i]._id%>' style='display:none'>
        <a class='delete' href>
            <span class="glyphicon glyphicon-trash"></span>
        </a>
    </td>
    <td>
        <input class='editInput' type="text"
            value='<%=data[i].name+","+data[i].age+","+data[i].sex+","+data[i].tel+","+data[i]._id%>'
            style='display:none'>
        <a class='edit' href>
            <span class="glyphicon glyphicon-edit"></span>
        </a>
    </td>
</tr>
<%}%>
</script>


<!-- 跳转页码 -->
<script type="text/html" id="page_span">
    <li><a class='a_page' toHref="/index">首页</a></li>
    <% pages.forEach(function(item){%>
<li><a class='a_page' toHref="<%='/index?page='+ item%>"><%=item%></a></li>
<%})%>
<li><a class='a_page' toHref="<%='/index?page='+ pageTotal%>">末页</a></li>
</script>




<!-- 查询标签 -->

<script type="text/html" id="search_btn">
    <!-- 姓名 -->
    <%if(condition.name){%>
<button type="button" class="btn btn-warning nameBtn" style="border-radius: 0;">姓名：<%-condition.name%></button><button
    type="button" class="btn btn-warning nameBtn deleteBtn name" style="width:20px;border-radius:0 ;">X</button>
<%}%>
    <!-- 年龄 -->
    <%if(condition.age){%>
<button type="button" class="btn btn-success ageBtn" style="border-radius: 0;">年龄：<%-condition.age%></button><button
    type="button" class="btn btn-success ageBtn deleteBtn age" style="width:20px;border-radius:0 ;">X</button>
<%}%>
    <!-- 性别 -->
    <%if(condition.sex){%>
<button type="button" class="btn btn-info sexBtn" style="border-radius: 0;">性别：<%-condition.sex%></button><button
    type="button" class="btn btn-info sexBtn deleteBtn sex" style="width:20px;border-radius:0 ;">X</button>
<%}%>
    <!-- 手机 -->
    <%if(condition.tel){%>
<button type="button" class="btn btn-danger telBtn" style="border-radius: 0;">手机：<%-condition.tel%></button><button
    type="button" class="btn btn-danger telBtn deleteBtn tel" style="width:20px;border-radius:0 ;">X</button>
<%}%>
</script>




<!-- get post请求 -->

<script>

    // 首页接口，查询学生
    window.onload = function (e) {
        console.log('网页加载完毕');
        $.get('/index').then(data => {
            let htmlStr = ejs.render($('#index_table').text(), data);
            let spanStr = ejs.render($('#page_span').text(), data);
            $('#tbody-content').html(htmlStr)
            $('.pagination').html(spanStr)
        })
    }

    // 添加学生
    $('#addBtn').click(function (e) {
        let params = $('#addStu').serialize();
        console.log('添加学生表单数据' + params);
        $.post('/api/stuAdd', params).then(data => {
            // data需要包含msg信息以及查询到的所有数据students
            alert(data.msg);
            if (data.err == 0) {
                // 添加成功返回首页
                location.href = '/';
            }
        })
    })

    // 删除学生
    $('#tbody-content').on('click', function (e) {
        // 点击a标签阻止其默认行为
        e.preventDefault();
        // 我吐了，动态生成的元素的绑定事件会出问题，这里使用事件委托解决
        // 获取到所点的元素的value
        if (e.target && e.target.className == 'glyphicon glyphicon-trash') {
            console.log('点击了删除');
            let deleteInput = e.target.parentNode.previousElementSibling.value;
            let flag = confirm('确定删除？');
            if(flag){
                $.get('/api/delete/' + deleteInput).then(data => {
                alert(data.msg);
                if (data.err == 0) {
                    location.href = '/'
                }
            })
            }
        }
        if (e.target && e.target.className == 'glyphicon glyphicon-edit') {
            console.log('点击了编辑');
            let editInput = e.target.parentNode.previousElementSibling.value;
            let objArr = editInput.split(',');
            // 模拟触发
            $('#update_a').click()
            $('#update_name').val(objArr[0])
            $('#update_age').val(objArr[1])
            if (objArr[2] == '男') {
                $('#update_isMale').attr("checked", 'checked');
            }
            if (objArr[2] == '女') {
                $('#update_isFemale').attr("checked", 'checked');
            }
            $('#update_tel').val(objArr[3])
            $('#update_id').val(objArr[4])
        }
    })

    // 更新学生接口访问
    $('#updateBtn').click(function (e) {
        let params = $('#updateStu').serialize();
        console.log('添加学生表单数据' + params);
        $.post('/api/edit', params).then(data => {
            // data需要包含msg信息以及查询到的所有数据students
            alert(data.msg);
            if (data.err == 0) {
                // 添加成功返回首页
                location.href = '/';
            }
        })
    })

    // 点击跳转页码的时候
    $('.pagination').click(function (e) {
        // 阻止a标签的默认行为
        e.preventDefault();
        console.log('点击页码');
        let getApi = $(e.target).attr('toHref');
        console.log(getApi);
        $.get(getApi).then(data => {
            console.log('页码跳转');
            let htmlStr = ejs.render($('#index_table').text(), data);
            let spanStr = ejs.render($('#page_span').text(), data);
            $('#tbody-content').html(htmlStr)
            $('.pagination').html(spanStr)
        })
    })

    // 学生查询
    $('#searchBtn').click(function (e) {
        let params = $('#searchStu').serialize();
        console.log('查询条件'+params);
        $.get('/index', params).then(data => {
            $('#close_modal').click()
            // data需要包含msg信息以及查询到的所有数据students
            let htmlStr = ejs.render($('#index_table').text(), data);
            let spanStr = ejs.render($('#page_span').text(), data);
            let btnStr = ejs.render($('#search_btn').text(), data);
            $('#tbody-content').html(htmlStr)
            $('.pagination').html(spanStr)
            $('#condition_box').html(btnStr)
        })
    })

    // 删除条件查询
    $('#condition_box').click(function (e) {
        // 阻止默认行为
        e.preventDefault();
        if (e.target && e.target.className.includes('deleteBtn')) {
            // 改变查询条件的内容
            if (e.target.className.includes('name')) {
                console.log('删除姓名条件');
                // $('#name').attr("value",'')
                $('#name').val('')
            }
            if (e.target.className.includes('age')) {
                console.log('删除年龄条件');
                // console.log($('#age').val(''));
                // $('#age').attr("value",'')
                $('#age').val('')
            }
            if (e.target.className.includes('sex')) {
                console.log('删除性别条件');
                $('#isMale').attr("checked",false)
                $('#isFemale').attr("checked",false)
            }
            if (e.target.className.includes('tel')) {
                console.log('删除手机条件');
                // console.log($('#tel').val(''));
                // $('#tel').attr("value",'')
                $('#tel').val('')
            }
            $('#searchBtn').click();
        }
    })
</script>
</html>